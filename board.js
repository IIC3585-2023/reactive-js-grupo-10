const board = document.getElementById("pacman-board");

let grid = [
    ["■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■"],
    ["■"," "," "," "," "," "," "," "," "," "," "," "," "," ","■"," "," "," "," "," "," "," "," "," "," "," ","■"," "," "," "," "," "," "," "," "," "," "," ","■"," "," "," "," "," "," "," "," "," "," "," "," "," ","■"],
    ["■"," "," "," "," "," "," "," "," "," "," "," "," "," ","■"," "," "," "," "," "," "," "," "," "," "," ","■"," "," "," "," "," "," "," "," "," "," "," ","■"," "," "," "," "," "," "," "," "," "," "," "," "," ","■"],
    ["■"," "," ","■","■","■"," "," ","■","■","■","■"," "," ","■"," "," ","■","■","■","■","■","■","■"," "," ","■"," "," ","■","■","■","■","■","■","■"," "," ","■"," "," ","■","■","■","■"," "," ","■","■","■"," "," ","■"],
    ["■"," "," ","■","■","■"," "," ","■","■","■","■"," "," ","■"," "," ","■","■","■","■","■","■","■"," "," ","■"," "," ","■","■","■","■","■","■","■"," "," ","■"," "," ","■","■","■","■"," "," ","■","■","■"," "," ","■"],
    ["■"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","■"],
    ["■"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","■"],
    ["■"," "," ","■","■","■"," "," ","■"," "," ","■","■","■","■","■","■","■"," "," ","■"," "," ","■","■","■","■","■","■","■"," "," ","■"," "," ","■","■","■","■","■","■","■"," "," ","■"," "," ","■","■","■"," "," ","■"],
    ["■"," "," "," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," "," "," ","■"],
    ["■"," "," "," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," "," "," ","■"],
    ["■","■","■","■","■","■"," "," ","■"," "," ","■"," "," ","■"," "," ","■","■","■","■","■","■","■"," "," ","■"," "," ","■","■","■","■","■","■","■"," "," ","■"," "," ","■"," "," ","■"," "," ","■","■","■","■","■","■"],
    ["■","■","■","■","■","■"," "," ","■"," "," ","■"," "," "," "," "," "," "," "," ","■"," "," "," "," "," "," "," "," "," "," "," ","■"," "," "," "," "," "," "," "," ","■"," "," ","■"," "," ","■","■","■","■","■","■"],
    ["■","■","■","■","■","■"," "," ","■"," "," ","■"," "," "," "," "," "," "," "," ","■"," "," "," "," "," "," "," "," "," "," "," ","■"," "," "," "," "," "," "," "," ","■"," "," ","■"," "," ","■","■","■","■","■","■"],
    ["■","■","■","■","■","■"," "," ","■"," "," ","■"," "," ","■","■","■","■"," "," ","■"," "," ","■","■"," "," "," ","■","■"," "," ","■"," "," ","■","■","■","■"," "," ","■"," "," ","■"," "," ","■","■","■","■","■","■"],
    ["■"," "," "," "," "," "," "," "," "," "," "," "," "," ","■"," "," "," "," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," "," "," ","■"],
    ["■"," "," "," "," "," "," "," "," "," "," "," "," "," ","■"," "," "," "," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," "," "," ","■"],
    ["■","■","■","■","■","■"," "," ","■"," "," ","■","■","■","■"," "," ","■","■","■","■"," "," ","■","■","■","■","■","■","■"," "," ","■","■","■","■"," "," ","■","■","■","■"," "," ","■"," "," ","■","■","■","■","■","■"],
    ["■","■","■","■","■","■"," "," ","■"," "," "," "," "," "," "," "," "," "," "," ","■"," "," "," "," "," "," "," "," "," "," "," ","■"," "," "," "," "," "," "," "," "," "," "," ","■"," "," ","■","■","■","■","■","■"],
    ["■","■","■","■","■","■"," "," ","■"," "," "," "," "," "," "," "," "," "," "," ","■"," "," "," "," "," "," "," "," "," "," "," ","■"," "," "," "," "," "," "," "," "," "," "," ","■"," "," ","■","■","■","■","■","■"],
    ["■","■","■","■","■","■"," "," ","■"," "," ","■","■","■","■","■","■","■"," "," ","■"," "," ","■","■","■","■","■","■","■"," "," ","■"," "," ","■","■","■","■","■","■","■"," "," ","■"," "," ","■","■","■","■","■","■"],
    ["■"," "," "," "," "," "," "," "," "," "," "," "," "," ","■"," "," "," "," "," "," "," "," "," "," "," ","■"," "," "," "," "," "," "," "," "," "," "," ","■"," "," "," "," "," "," "," "," "," "," "," "," "," ","■"],
    ["■"," "," "," "," "," "," "," "," "," "," "," "," "," ","■"," "," "," "," "," "," "," "," "," "," "," ","■"," "," "," "," "," "," "," "," "," "," "," ","■"," "," "," "," "," "," "," "," "," "," "," "," "," ","■"],
    ["■"," "," ","■","■","■"," "," ","■","■","■","■"," "," ","■"," "," ","■","■","■","■","■","■","■"," "," ","■"," "," ","■","■","■","■","■","■","■"," "," ","■"," "," ","■","■","■","■"," "," ","■","■","■"," "," ","■"],
    ["■"," "," "," "," ","■"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","■"," "," "," "," ","■"],
    ["■"," "," "," "," ","■"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","■"," "," "," "," ","■"],
    ["■","■","■"," "," ","■"," "," ","■"," "," ","■","■","■","■","■","■","■"," "," ","■"," "," ","■","■","■","■","■","■","■"," "," ","■"," "," ","■","■","■","■","■","■","■"," "," ","■"," "," ","■"," "," ","■","■","■"],
    ["■"," "," "," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," "," "," ","■"],
    ["■"," "," "," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," ","■"," "," "," "," "," "," "," ","■"],
    ["■"," "," ","■","■","■","■","■","■","■","■","■"," "," ","■"," "," ","■","■","■","■","■","■","■"," "," ","■"," "," ","■","■","■","■","■","■","■"," "," ","■"," "," ","■","■","■","■","■","■","■","■","■"," "," ","■"],
    ["■"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","■"],
    ["■"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","■"],
    ["■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■","■"],
]

const CELL_SIZE = 20
const DOT_RADIUS = CELL_SIZE * 0.1
const PLAYER_RADIUS = CELL_SIZE * 0.75
const GHOST_RADIUS = PLAYER_RADIUS

board.width = CELL_SIZE * grid[0].length
board.height = CELL_SIZE * grid.length

const ctx = board.getContext("2d")

let walls = []

function drawBoard() {
    for(let row = 0; row < grid.length; row++) {
        for(let col = 0; col < grid[0].length; col++) {
            if (grid[row][col] == " ") {
                ctx.fillStyle = "#000000"
            } else {
                walls.push([col, row])
                ctx.fillStyle = "#0000A6"
            }
            ctx.fillRect(col * CELL_SIZE, row * CELL_SIZE, CELL_SIZE, CELL_SIZE)
        }
    }
}

let dots = []

// los caminos son de dos bloques, ponemos el dot en medio de 4 bloques
for(let row = 1; row < grid.length; row++) {
    for(let col = 1; col < grid[0].length; col++) {

        let cellUpLeft = grid[row-1][col-1] == " "
        let cellLeft = grid[row][col-1] == " "
        let cellRight = grid[row-1][col] == " "
        let currCell = grid[row][col] == " "

        if (cellUpLeft && cellLeft && cellRight && currCell) {
            dots.push([col, row])
        }
    }
}

let intersections = []

// interseccon de caminos, logica fantasmas
for(let i = 0; i < dots.length; i++){
    let dot = dots[i]
    let dotCol = dot[0]
    let dotRow = dot[1]

    let isDotUp = dots.some(d => (d[0] == dotCol) && (d[1] == dotRow-1))
    let isDotDown = dots.some(d => (d[0] == dotCol) && (d[1] == dotRow+1))
    let isDotLeft = dots.some(d => (d[0] == dotCol-1) && (d[1] == dotRow))
    let isDotRight = dots.some(d => (d[0] == dotCol+1) && (d[1] == dotRow))

    let andUL = isDotUp && isDotLeft
    let andUR = isDotUp && isDotRight
    let andLD = isDotLeft && isDotDown
    let andRD = isDotRight && isDotDown

    if (andUL || andUR || andLD || andRD){
        intersections.push([dotCol, dotRow])
    }
    // Caminos sin salida
    if ((isDotUp + isDotDown + isDotLeft + isDotRight) == 1) {
        intersections.push([dotCol, dotRow])
    }
}

function drawDots() {
    // ctx.fillStyle = '#00a308' //#964b4b
    for(let i = 0; i < dots.length; i++) {
        let dot = dots[i]
        let dotCenterX = dot[0] * CELL_SIZE
        let dotCenterY = dot[1] * CELL_SIZE
        ctx.beginPath();
        ctx.arc(dotCenterX, dotCenterY, DOT_RADIUS, 0, 2 * Math.PI);
        ctx.fillStyle = "white"
        ctx.fill()
    }
}

// pacman vs muralla
// Basado en https://stackoverflow.com/a/16012490
function rectanglesIntersect(minAx, minAy, minBx, minBy) {
    let maxAx = minAx + 1 // Pared (cantidad de celdas = 1)
    let maxAy = minAy + 1 // Pared
    let maxBx = minBx + 2 // Jugador (cantidad de celdas = 2)
    let maxBy = minBy + 2 // Jugador
    let aLeftOfB = maxAx <= minBx;
    let aRightOfB = minAx >= maxBx;
    let aAboveB = minAy >= maxBy;
    let aBelowB = maxAy <= minBy;

    return !( aLeftOfB || aRightOfB || aAboveB || aBelowB );
}

function checkNoCollision(x, y) {
    let playerCol = (x / CELL_SIZE) - 1
    let playerRow = (y / CELL_SIZE) - 1
    for(let i = 0; i < walls.length; i++){
        let wall = walls[i]
        let wallCol = wall[0]
        let wallRow = wall[1]
        if (rectanglesIntersect(wallCol, wallRow, playerCol, playerRow)){
            return false
        }
    }
    return true
}

// Basado en https://stackoverflow.com/a/68841877
function circlesIntersect(dotX, dotY, playerX, playerY) {
    return Math.hypot(dotX-playerX, dotY-playerY) <= DOT_RADIUS + PLAYER_RADIUS
}

function checkDotCollection(x, y) {
    for(let i = 0; i < dots.length; i++){
        let dot = dots[i]
        let dotX = dot[0] * CELL_SIZE
        let dotY = dot[1] * CELL_SIZE
        if (circlesIntersect(dotX, dotY, x, y)){
            dots = dots.filter(item => item !== dot)
            drawDots()
        }
    }
}

function checkIntersection(x, y) {
    let ghostCol = x / CELL_SIZE
    let ghostRow = y / CELL_SIZE
    return intersections.some(i => (i[0] == ghostCol) && (i[1] == ghostRow))
}

function checkCollisionPlayerGhosts(playerX, playerY, ghostX, ghostY) {
    return Math.hypot(ghostX-playerX, ghostY-playerY) <= GHOST_RADIUS/2 + PLAYER_RADIUS/2
}